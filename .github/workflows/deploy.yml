name: Deploy by checkout, screenshot, worktree deploy

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

concurrency:
  group: "deploy-screenshots"
  cancel-in-progress: false

jobs:
  update-screenshots-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for lockfile
        id: check-lock
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ] || [ -f yarn.lock ]; then
            echo "lockfile=true" >> $GITHUB_OUTPUT
          else
            echo "lockfile=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Ruby for Jekyll preview
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true
          cache-version: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Restore npm cache (only when lockfile present)
        if: ${{ steps.check-lock.outputs.lockfile == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json','**/npm-shrinkwrap.json','**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install npm dependencies (lockfile present -> npm ci)
        if: ${{ steps.check-lock.outputs.lockfile == 'true' }}
        run: npm ci
        env:
          CI: "true"

      - name: Install npm dependencies (no lockfile -> npm install)
        if: ${{ steps.check-lock.outputs.lockfile == 'false' }}
        run: npm install --no-audit --no-fund
        env:
          CI: "true"

      - name: Start local server and wait for availability
        run: |
          npm run serve &>/tmp/serve.log &
          echo "Started local server, logging to /tmp/serve.log"
          MAX_WAIT=60
          URL="${{ env.SCREENSHOT_URL_OVERRIDE || 'http://127.0.0.1:4000/' }}"
          for i in $(seq 1 $MAX_WAIT); do
            if curl -sS --fail "$URL" >/dev/null 2>&1; then
              echo "Server is up at $URL (after $i seconds)"
              break
            fi
            echo "Waiting for server at $URL... ($i/$MAX_WAIT)"
            sleep 1
          done
          if ! curl -sS --fail "$URL" >/dev/null 2>&1; then
            echo "Server did not become available within ${MAX_WAIT}s"
            echo "---- /tmp/serve.log (last 200 lines) ----"
            tail -n 200 /tmp/serve.log || true
            exit 1
          fi
        env:
          CI: "true"

      - name: Run screenshot script
        run: npm run ss
        env:
          SCREENSHOT_URL: ${{ env.SCREENSHOT_URL_OVERRIDE || 'http://127.0.0.1:4000/' }}
          SCREENSHOT_DIR: assets/og

      - name: Prepare git for deploy branch operations
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git fetch origin --prune

      - name: Commit and push screenshots using git worktree
        run: |
          set -euo pipefail

          TARGET_BRANCH="deploy"
          WORKTREE_DIR="$(mktemp -d /tmp/deploy-worktree-XXXX)"
          SCREENSHOT_DIR="assets/og"

          echo "Using worktree dir: ${WORKTREE_DIR}"
          echo "Target deploy branch: ${TARGET_BRANCH}"

          # Ensure we have latest refs
          git fetch origin --prune

          # If deploy branch exists on remote, create a worktree from origin/deploy.
          if git ls-remote --heads origin "${TARGET_BRANCH}" | grep -q "${TARGET_BRANCH}"; then
            echo "Remote branch origin/${TARGET_BRANCH} exists. Creating worktree from it."
            # Try to add a worktree from the remote branch
            git worktree add --checkout "${WORKTREE_DIR}" "origin/${TARGET_BRANCH}" || {
              # fallback: create a local branch tracking origin/TARGET_BRANCH and then worktree
              git branch --track "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}" || true
              git worktree add --checkout "${WORKTREE_DIR}" "${TARGET_BRANCH}"
            }
          else
            echo "Remote branch origin/${TARGET_BRANCH} does not exist. Initializing an orphan deploy branch in worktree."
            # Create an orphan branch in the worktree so we don't disturb the current working tree
            # Initialize an empty repo state in the worktree
            git init "${WORKTREE_DIR}"
            pushd "${WORKTREE_DIR}" >/dev/null
            git remote add origin "https://github.com/${{ github.repository }}.git"
            # Create orphan branch and an initial empty commit
            git checkout --orphan "${TARGET_BRANCH}" || true
            git commit --allow-empty -m "Initialize ${TARGET_BRANCH} branch"
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" "${TARGET_BRANCH}"
            popd >/dev/null
            # Now add worktree from newly-created remote branch
            git worktree add --checkout "${WORKTREE_DIR}" "origin/${TARGET_BRANCH}" || git worktree add --checkout "${WORKTREE_DIR}" "${TARGET_BRANCH}"
          fi

          # Ensure worktree has a git identity
          pushd "${WORKTREE_DIR}" >/dev/null
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          popd >/dev/null

          # Copy screenshots into the worktree (preserve only that directory)
          if [ -d "${SCREENSHOT_DIR}" ]; then
            echo "Copying screenshots to worktree..."
            mkdir -p "${WORKTREE_DIR}/assets"
            # Use rsync semantics if available to replace the directory contents
            if command -v rsync >/dev/null 2>&1; then
              rsync -a --delete "${SCREENSHOT_DIR}/" "${WORKTREE_DIR}/assets/og/"
            else
              rm -rf "${WORKTREE_DIR}/assets/og" || true
              cp -a "${SCREENSHOT_DIR}" "${WORKTREE_DIR}/assets/" || true
            fi
          else
            echo "No screenshots found at ${SCREENSHOT_DIR}; nothing to copy."
          fi

          # Commit and push only the screenshots in the worktree
          pushd "${WORKTREE_DIR}" >/dev/null

          # Remove accidentally tracked build artifacts from index if present
          git rm -r --cached --ignore-unmatch _site .bundle vendor node_modules || true
          git rm --cached --ignore-unmatch Gemfile.lock package-lock.json || true

          # Stage only assets/og (create the path in case it's not present)
          if [ -d "assets/og" ]; then
            git add -- "assets/og"
          fi

          if [ -n "$(git diff --cached --name-only || true)" ]; then
            git commit -m "Update screenshots [skip ci]" || true
            # Push to deploy branch explicitly
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:"${TARGET_BRANCH}" --follow-tags
          else
            echo "No changes to commit in worktree."
          fi

          popd >/dev/null

          # Remove the worktree and prune
          git worktree remove "${WORKTREE_DIR}" --force || true
          git worktree prune || true

      - name: Show pushed branch info
        run: |
          # Show the deploy branch tip on the remote
          git fetch origin deploy:refs/remotes/origin/deploy || true
          echo "Remote deploy branch last commits:"
          git --no-pager log -n 5 --oneline origin/deploy || echo "No origin/deploy branch."
